<!-- Navbar -->
<div class="navbar bg-base-100 shadow-lg">
  <div class="flex-1">
    <a class="btn btn-ghost text-xl">üì¶ Inventory Manager</a>
  </div>
  <div class="flex-none">
    @if (lowStockItems().length > 0) {
      <div class="badge badge-error gap-2">
        {{ lowStockItems().length }} cr√≠ticos
      </div>
    }
  </div>
</div>

<!-- Toast Notifications -->
<app-toast></app-toast>

<!-- Main Container -->
<div class="container mx-auto px-4 py-8">
  <!-- Stats Cards -->
  <div class="stats shadow mb-8 w-full">
    <div class="stat">
      <div class="stat-figure text-primary">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
      </div>
      <div class="stat-title">Total Items</div>
      <div class="stat-value text-primary">{{ totalItems() }}</div>
    </div>

    <div class="stat">
      <div class="stat-figure text-error">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
      </div>
      <div class="stat-title">Stock Cr√≠tico</div>
      <div class="stat-value text-error">{{ lowStockItems().length }}</div>
    </div>

    <div class="stat">
      <div class="stat-figure text-success">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      </div>
      <div class="stat-title">Valor Total</div>
      <div class="stat-value text-success">${{ totalValue().toFixed(2) }}</div>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading() && items().length === 0) {
    <div class="flex justify-center items-center py-20">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }

  <!-- Items Grid -->
  @if (items().length > 0) {
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      @for (item of items(); track item.id) {
        <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow">
          <div class="card-body">
            <!-- Header with Badge -->
            <div class="flex justify-between items-start mb-2">
              <h2 class="card-title text-lg">{{ item.name }}</h2>
              <div [class]="'badge ' + getCategoryBadge(item.category)">
                {{ item.category }}
              </div>
            </div>

            <!-- Description -->
            <p class="text-sm opacity-70 mb-4">{{ item.description || 'Sin descripci√≥n' }}</p>

            <!-- Stock Badge -->
            <div class="flex items-center gap-2 mb-3">
              <span class="font-semibold">Stock:</span>
              <div [class]="'badge badge-lg ' + (isLowStock(item) ? 'badge-error' : 'badge-success')">
                {{ item.stock }} unidades
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="mb-4">
              <div class="flex justify-between text-xs mb-1">
                <span>Nivel de stock</span>
                <span>{{ ((item.stock / (item.criticalLimit * 2)) * 100).toFixed(0) }}%</span>
              </div>
              <progress
                [class]="'progress ' + (isLowStock(item) ? 'progress-error' : 'progress-success')"
                [value]="item.stock"
                [max]="item.criticalLimit * 2"
              ></progress>
            </div>

            <!-- Details -->
            <div class="divider my-2"></div>
            <div class="grid grid-cols-2 gap-2 text-sm mb-4">
              <div>
                <span class="opacity-70">Precio:</span>
                <span class="font-semibold ml-1">${{ item.unitPrice.toFixed(2) }}</span>
              </div>
              <div>
                <span class="opacity-70">Valor:</span>
                <span class="font-semibold ml-1">${{ (item.stock * item.unitPrice).toFixed(2) }}</span>
              </div>
              <div class="col-span-2">
                <span class="opacity-70">L√≠mite cr√≠tico:</span>
                <span class="font-semibold ml-1">{{ item.criticalLimit }} unidades</span>
              </div>
            </div>

            <!-- Action Button -->
            <div class="card-actions justify-end">
              <button
                (click)="openTransactionModal(item)"
                class="btn btn-primary btn-sm"
              >
                Registrar Movimiento
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Transaction Modal -->
@if (showModal() && selectedItem()) {
  <div class="modal modal-open">
    <div class="modal-box max-w-md">
      <h3 class="font-bold text-lg mb-2">Registrar Movimiento</h3>
      <p class="text-sm opacity-70 mb-4">{{ selectedItem()!.name }}</p>

      <!-- Error Alert -->
      @if (error()) {
        <div class="alert alert-error mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          <span>{{ error() }}</span>
        </div>
      }

      <!-- Current Stock -->
      <div class="alert alert-info mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <div>
          <div class="text-xs">Stock actual</div>
          <div class="text-2xl font-bold">{{ selectedItem()!.stock }}</div>
        </div>
      </div>

      <!-- Transaction Type -->
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text font-semibold">Tipo de Movimiento</span>
        </label>
        <div class="btn-group w-full">
          <button
            (click)="transactionType.set(TransactionType.ENTRADA); error.set(null)"
            [class]="transactionType() === TransactionType.ENTRADA ? 'btn btn-success btn-active' : 'btn'"
            class="flex-1"
          >
            ‚¨ÜÔ∏è ENTRADA
          </button>
          <button
            (click)="transactionType.set(TransactionType.SALIDA); error.set(null)"
            [class]="transactionType() === TransactionType.SALIDA ? 'btn btn-error btn-active' : 'btn'"
            class="flex-1"
          >
            ‚¨áÔ∏è SALIDA
          </button>
        </div>
      </div>

      <!-- Quantity -->
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text font-semibold">Cantidad</span>
        </label>
        <input
          type="number"
          min="1"
          [(ngModel)]="quantity"
          (ngModelChange)="quantity.set($event); error.set(null)"
          class="input input-bordered"
        />
      </div>

      <!-- User (optional) -->
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text">Usuario (opcional)</span>
        </label>
        <input
          type="text"
          [(ngModel)]="userName"
          (ngModelChange)="userName.set($event)"
          placeholder="Tu nombre"
          class="input input-bordered"
        />
      </div>

      <!-- Preview -->
      <div [class]="'alert mb-4 ' + (transactionType() === TransactionType.ENTRADA ? 'alert-success' : 'alert-warning')">
        <div class="w-full text-center">
          <div class="text-xs opacity-70">Nuevo stock</div>
          <div class="text-3xl font-bold">
            @if (transactionType() === TransactionType.ENTRADA) {
              {{ selectedItem()!.stock + quantity() }}
            } @else {
              {{ selectedItem()!.stock - quantity() }}
            }
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="modal-action">
        <button
          (click)="closeModal()"
          [disabled]="loading()"
          class="btn"
        >
          Cancelar
        </button>
        <button
          (click)="submitTransaction()"
          [disabled]="loading() || quantity() < 1"
          [class]="transactionType() === TransactionType.ENTRADA ? 'btn btn-success' : 'btn btn-error'"
        >
          @if (loading()) {
            <span class="loading loading-spinner"></span>
            Procesando...
          } @else {
            Confirmar
          }
        </button>
      </div>
    </div>
  </div>
}
